version: '3.8'

services:
  podcast-harvester:
    build: .
    container_name: podcast-harvester-download
    volumes:
      # Mount local directories for data persistence
      - /Volumes/MEDIA/data/podcasts/downloads:/app/downloads
      - /Volumes/MEDIA/data/podcasts/sources:/app/sources
      - /Volumes/MEDIA/data/podcasts/config:/app/config
      # Mount configuration files
      - /Volumes/MEDIA/data/podcasts/channels_config_docker.json:/app/channels_config.json:ro
      - /Volumes/MEDIA/data/podcasts/llm_config_docker.json:/app/llm_config.json:ro
    environment:
      - PYTHONUNBUFFERED=1
    command: >
      python3 podcast_harvester.py 
      --config channels_config.json
    restart: "no"

  # podcast-harvester:
  #   build: .
  #   container_name: podcast-harvester-download
  #   volumes:
  #     # Mount local directories for data persistence
  #     - /Volumes/MEDIA/data/podcasts/downloads:/app/downloads
  #     - /Volumes/MEDIA/data/podcasts/sources:/app/sources
  #     - /Volumes/MEDIA/data/podcasts/config:/app/config
  #     # Mount configuration files
  #     - /Volumes/MEDIA/data/podcasts/channels_config_docker.json:/app/channels_config.json:ro
  #     - /Volumes/MEDIA/data/podcasts/llm_config_docker.json:/app/llm_config.json:ro
  #   environment:
  #     - PYTHONUNBUFFERED=1
  #   command: >
  #     tail -f /dev/null
  #   restart: "no"

  podcast-harvester-reindex:
    build: .
    container_name: podcast-harvester-download-force-reindex
    volumes:
      # Mount local directories for data persistence
      - /Volumes/MEDIA/data/podcasts/downloads:/app/downloads
      - /Volumes/MEDIA/data/podcasts/sources:/app/sources
      - /Volumes/MEDIA/data/podcasts/config:/app/config
      # Mount configuration files
      - /Volumes/MEDIA/data/podcasts/channels_config_docker.json:/app/channels_config.json:ro
      - /Volumes/MEDIA/data/podcasts/llm_config.json:/app/llm_config.json:ro
    environment:
      - PYTHONUNBUFFERED=1
    command: >
      python3 podcast_harvester.py 
      --config channels_config.json --force-reindex
    restart: "no"

  signal-notification-reindex:
    image: curlimages/curl:latest
    container_name: podcast-harvester-signal-notify-reindex
    depends_on:
      - podcast-harvester-reindex
    environment:
      - SIGNAL_API_URL=http://host.docker.internal:8080/v2/send
      - PHONE_NUMBER=+1234567890
    command: >
      sh -c "
      curl -X POST -H 'Content-Type: application/json' 
      '$$SIGNAL_API_URL' 
      -d '{\"message\": \"ðŸ”„ Podcast reindexing completed!\", \"number\": \"$$PHONE_NUMBER\", \"recipients\": [\"$$PHONE_NUMBER\"]}' || true
      "
    restart: "no"
